<!DOCTYPE html>

<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Sana Admin - User Management</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#11d452",
              "background-light": "#f6f8f6",
              "background-dark": "#102216",
              "orange-accent": "#ff9f1c",
              "peach-accent": "#ffdab9",
              "text-light": "#102216",
              "text-dark": "#f6f8f6",
              "card-light": "#ffffff",
              "card-dark": "#1a3824",
              "border-light": "#e2e8f0",
              "border-dark": "#2d573d",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };

      // Custom confirmation modal helper
      function showConfirmModal(message, title = "Confirm") {
        return new Promise((resolve) => {
          const overlay = document.createElement("div");
          overlay.className =
            "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4";

          const modal = document.createElement("div");
          modal.className =
            "bg-white dark:bg-card-dark rounded-lg shadow-lg max-w-sm w-full animate-[scale-in_0.2s_ease-out]";
          modal.style.animation = "scale-in 0.2s ease-out";

          modal.innerHTML = `
            <div class="p-6">
              <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-2">${title}</h3>
              <p class="text-text-light dark:text-text-dark mb-6 text-sm leading-relaxed">${message}</p>
              <div class="flex gap-3 justify-end">
                <button 
                  id="confirm-cancel" 
                  class="px-4 py-2 rounded-lg bg-border-light dark:bg-border-dark text-text-light dark:text-text-dark hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-sm"
                >
                  Cancel
                </button>
                <button 
                  id="confirm-ok" 
                  class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors font-medium text-sm"
                >
                  Confirm
                </button>
              </div>
            </div>
          `;

          overlay.appendChild(modal);
          document.body.appendChild(overlay);

          const cleanup = () => {
            overlay.remove();
          };

          document
            .getElementById("confirm-ok")
            .addEventListener("click", () => {
              cleanup();
              resolve(true);
            });

          document
            .getElementById("confirm-cancel")
            .addEventListener("click", () => {
              cleanup();
              resolve(false);
            });

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) {
              cleanup();
              resolve(false);
            }
          });
        });
      }
    </script>
    <style>
      @keyframes scale-in {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
  </head>
  <body
    class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark"
  >
    <div class="relative flex min-h-screen w-full">
      <!-- SideNavBar -->
      <aside
        class="flex flex-col w-64 border-r border-primary/20 dark:border-primary/10 bg-background-light dark:bg-background-dark"
      >
        <div class="flex h-full flex-col justify-between p-4">
          <div class="flex flex-col gap-4">
            <div class="flex items-center gap-3 p-2">
              <div
                class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 flex items-center justify-center text-text-dark font-semibold text-lg"
                id="admin-avatar"
                data-alt="Admin Profile Picture"
                style="background-color: #4f9651"
              >
                A
              </div>
              <div class="flex flex-col">
                <h1
                  class="text-text-light dark:text-text-dark text-base font-medium leading-normal"
                  data-admin-name
                >
                  Loading...
                </h1>
              </div>
            </div>
            <nav class="flex flex-col gap-2 mt-4">
              <a
                class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10"
                href="admin.html"
              >
                <span
                  class="material-symbols-outlined text-text-light dark:text-text-dark"
                  >dashboard</span
                >
                <p
                  class="text-text-light dark:text-text-dark text-sm font-medium leading-normal"
                >
                  Dashboard
                </p>
              </a>
              <a
                class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30"
                href="usermgt.html"
              >
                <span
                  class="material-symbols-outlined text-primary"
                  style="font-variation-settings: 'FILL' 1"
                  >group</span
                >
                <p class="text-primary text-sm font-medium leading-normal">
                  User Management
                </p>
              </a>

              <a
                class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10"
                href="adminsettings.html"
              >
                <span
                  class="material-symbols-outlined text-text-light dark:text-text-dark"
                  >settings</span
                >
                <p
                  class="text-text-light dark:text-text-dark text-sm font-medium leading-normal"
                >
                  Settings
                </p>
              </a>
            </nav>
          </div>
          <div class="flex flex-col gap-1">
            <a
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10"
              href="#"
            >
              <span
                class="material-symbols-outlined text-text-light dark:text-text-dark"
                >help</span
              >
              <p
                class="text-text-light dark:text-text-dark text-sm font-medium leading-normal"
              >
                Support
              </p>
            </a>
            <a
              id="logout-link"
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 cursor-pointer"
              href="#"
            >
              <span
                class="material-symbols-outlined text-text-light dark:text-text-dark"
                >logout</span
              >
              <p
                class="text-text-light dark:text-text-dark text-sm font-medium leading-normal"
              >
                Log out
              </p>
            </a>
          </div>
        </div>
      </aside>
      <!-- Main Content -->
      <main class="flex-1 p-8">
        <div class="flex flex-col gap-6 max-w-7xl mx-auto">
          <!-- Page Heading -->
          <div class="flex flex-wrap justify-between gap-4 items-center">
            <div class="flex flex-col gap-1">
              <h1
                class="text-text-light dark:text-text-dark text-3xl font-bold leading-tight tracking-tight"
              >
                User Management
              </h1>
              <p
                class="text-text-muted-light dark:text-text-muted-dark text-base font-normal leading-normal"
              >
                View, search, and manage all student users.
              </p>
            </div>
            <button
              id="add-user-btn"
              class="flex items-center justify-center gap-2 h-10 px-4 bg-primary text-white rounded-lg text-sm font-medium shadow-sm hover:bg-primary/90"
            >
              <span class="material-symbols-outlined">add</span>
              Add User
            </button>
          </div>
          <!-- Search and Filter Bar -->
          <div class="flex flex-col sm:flex-row gap-4">
            <!-- SearchBar -->
            <div class="flex-grow">
              <label class="flex flex-col h-12 w-full">
                <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                  <div
                    class="text-text-muted-light dark:text-text-muted-dark flex bg-primary/10 dark:bg-primary/20 items-center justify-center pl-4 rounded-l-lg"
                  >
                    <span class="material-symbols-outlined">search</span>
                  </div>
                  <input
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 border-none bg-primary/10 dark:bg-primary/20 h-full placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                    placeholder="Search users by name, email, student ID..."
                    value=""
                  />
                </div>
              </label>
            </div>
            <!-- Chips/Filters -->
            <div class="flex gap-3 items-center">
              <button
                class="flex h-12 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary/10 dark:bg-primary/20 px-4"
              >
                <p
                  class="text-text-light dark:text-text-dark text-sm font-medium leading-normal"
                >
                  Status: All
                </p>
                <span
                  class="material-symbols-outlined text-text-light dark:text-text-dark text-base"
                  >expand_more</span
                >
              </button>
              <button
                class="flex h-12 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary/10 dark:bg-primary/20 px-4"
              >
                <p
                  class="text-text-light dark:text-text-dark text-sm font-medium leading-normal"
                >
                  Campus: All
                </p>
                <span
                  class="material-symbols-outlined text-text-light dark:text-text-dark text-base"
                  >expand_more</span
                >
              </button>
            </div>
          </div>
          <!-- Table -->
          <div
            class="overflow-hidden rounded-lg border border-primary/20 dark:border-primary/10"
          >
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-primary/10 dark:bg-primary/20">
                    <th
                      class="px-6 py-4 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider"
                    >
                      User
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider"
                    >
                      Email
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider"
                    >
                      Role
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider"
                    >
                      Joined
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider"
                    >
                      Last Active
                    </th>
                    <th
                      class="px-6 py-4 text-right text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  class="divide-y divide-primary/10 dark:divide-primary/20"
                  id="users-tbody"
                >
                  <!-- Users will be loaded here dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          <!-- Pagination -->
          <div class="flex items-center justify-between mt-2">
            <div
              class="text-sm text-text-muted-light dark:text-text-muted-dark"
            >
              Showing <span class="font-medium">1</span> to
              <span class="font-medium">5</span> of
              <span class="font-medium">97</span> results
            </div>
            <div class="flex items-center gap-2">
              <button
                class="flex items-center justify-center h-9 w-9 rounded-lg border border-primary/20 dark:border-primary/10 text-text-muted-light dark:text-text-muted-dark hover:bg-primary/10"
              >
                <span class="material-symbols-outlined text-lg"
                  >chevron_left</span
                >
              </button>
              <button
                class="flex items-center justify-center h-9 w-9 rounded-lg bg-primary/20 text-primary text-sm font-medium"
              >
                1
              </button>
              <button
                class="flex items-center justify-center h-9 w-9 rounded-lg text-text-muted-light dark:text-text-muted-dark text-sm hover:bg-primary/10"
              >
                2
              </button>
              <button
                class="flex items-center justify-center h-9 w-9 rounded-lg text-text-muted-light dark:text-text-muted-dark text-sm hover:bg-primary/10"
              >
                3
              </button>
              <span class="text-text-muted-light dark:text-text-muted-dark"
                >...</span
              >
              <button
                class="flex items-center justify-center h-9 w-9 rounded-lg text-text-muted-light dark:text-text-muted-dark text-sm hover:bg-primary/10"
              >
                20
              </button>
              <button
                class="flex items-center justify-center h-9 w-9 rounded-lg border border-primary/20 dark:border-primary/10 text-text-muted-light dark:text-text-muted-dark hover:bg-primary/10"
              >
                <span class="material-symbols-outlined text-lg"
                  >chevron_right</span
                >
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      // Session verification - ensure only admin can access this page
      async function verifyAdminSession() {
        try {
          const response = await fetch("../php/api.php?action=get_user");
          const data = await response.json();

          if (!data.ok || data.user.role !== "admin") {
            console.error("Not authorized. Redirecting to login...");
            window.location.href = "../index.html";
            return false;
          }

          // Update admin profile info
          updateAdminProfile(data.user);

          return true;
        } catch (error) {
          console.error("Session verification failed:", error);
          window.location.href = "../index.html";
          return false;
        }
      }

      // Update admin profile in sidebar
      function updateAdminProfile(user) {
        // Update name
        const adminNameElement = document.querySelector("[data-admin-name]");
        if (adminNameElement && user.display_name) {
          adminNameElement.textContent = user.display_name;
        }

        // Update email
        const adminEmailElement = document.querySelector("[data-admin-email]");
        if (adminEmailElement && user.email) {
          adminEmailElement.textContent = user.email;
        }

        // Update avatar with first letter
        const avatarElement = document.getElementById("admin-avatar");
        if (avatarElement) {
          const firstLetter = (user.display_name || user.email)
            .charAt(0)
            .toUpperCase();
          avatarElement.textContent = firstLetter;
        }

        console.log(
          "[User Management] Admin profile updated:",
          user.display_name || user.email
        );
      } // Load and display users from database
      async function loadUsers() {
        try {
          console.log("Loading users...");
          const response = await fetch("../php/api.php?action=get_all_users");
          const data = await response.json();

          if (!data.ok) {
            console.error("Error fetching users:", data.error);
            return;
          }

          const tbody = document.getElementById("users-tbody");
          tbody.innerHTML = "";

          console.log("Users loaded:", data.users.length);

          data.users.forEach((user) => {
            const row = createUserRow(user);
            tbody.appendChild(row);
          });

          // Update pagination info
          const resultsText = document.querySelector(
            ".text-sm.text-text-muted-light"
          );
          if (resultsText) {
            const showing = Math.min(data.users.length, 5);
            resultsText.innerHTML = `Showing <span class="font-medium">1</span> to <span class="font-medium">${showing}</span> of <span class="font-medium">${data.total}</span> results`;
          }
        } catch (error) {
          console.error("Failed to load users:", error);
          // Retry after 2 seconds
          setTimeout(loadUsers, 2000);
        }
      }

      // Create a user row element
      function createUserRow(user) {
        const tr = document.createElement("tr");

        const registeredDate = new Date(user.created_at);
        const formattedDate = registeredDate.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });

        const lastSeenDate = user.last_seen ? new Date(user.last_seen) : null;
        const formattedLastSeen = lastSeenDate
          ? lastSeenDate.toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            })
          : "Never";

        const roleDisplay = user.role
          ? user.role.charAt(0).toUpperCase() + user.role.slice(1)
          : "Student";
        const isAdmin = user.role === "admin";

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <div class="h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-semibold">
                  ${user.display_name.charAt(0).toUpperCase()}
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-text-light dark:text-text-dark">
                  ${escapeHtml(user.display_name)}
                </div>
                <div class="text-sm text-text-muted-light dark:text-text-muted-dark">
                  ${escapeHtml(user.email)}
                </div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark">
            ${escapeHtml(user.email)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark">
            ${roleDisplay}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark">
            ${formattedDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark">
            ${formattedLastSeen}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-primary hover:text-primary/80" title="More actions">
              <span class="material-symbols-outlined">more_vert</span>
            </button>
          </td>
        `;

        return tr;
      }

      // Utility function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("Page loaded. Verifying admin session...");
        const isAdmin = await verifyAdminSession();
        if (isAdmin) {
          loadUsers();
        }
      });

      // Modal and toast helpers for Add User
      function showAddUserModal() {
        const modal = document.getElementById("add-user-modal");
        if (!modal) return;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      function hideAddUserModal() {
        const modal = document.getElementById("add-user-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
      function showToast(message, type = "success", timeout = 3000) {
        const container = document.getElementById("toast-container");
        if (!container) return;
        const el = document.createElement("div");
        el.className = `rounded-lg px-4 py-2 shadow-md text-sm text-white ${
          type === "error" ? "bg-red-500" : "bg-green-500"
        }`;
        el.textContent = message;
        container.appendChild(el);
        setTimeout(() => {
          el.classList.add("opacity-0");
          setTimeout(() => el.remove(), 300);
        }, timeout);
      }

      async function submitAddUserForm(e) {
        e.preventDefault();
        const name = document.getElementById("add-name").value.trim();
        const email = document.getElementById("add-email").value.trim();
        const role = document.getElementById("add-role").value;
        const password = document.getElementById("add-password").value;
        if (!name || !email)
          return showToast("Name and email required", "error");
        if (password && password.length > 0 && password.length < 6)
          return showToast("Password must be at least 6 characters", "error");

        try {
          const res = await fetch("../php/api.php?action=create_user", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              display_name: name,
              email: email,
              role: role,
              password: password,
            }),
          });
          const data = await res.json();
          if (!data.ok) {
            showToast("Create failed: " + (data.error || "unknown"), "error");
            return;
          }
          hideAddUserModal();
          showToast("User created", "success");
          // clear form
          document.getElementById("add-user-form").reset();
          // reload users
          if (typeof loadUsers === "function") loadUsers();
        } catch (err) {
          console.error("Create user error", err);
          showToast("Create failed", "error");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const addBtn = document.getElementById("add-user-btn");
        if (addBtn) addBtn.addEventListener("click", showAddUserModal);
        const cancel = document.getElementById("add-cancel");
        if (cancel) cancel.addEventListener("click", hideAddUserModal);
        const form = document.getElementById("add-user-form");
        if (form) form.addEventListener("submit", submitAddUserForm);
      });
    </script>
    <!-- Add User Modal -->
    <div
      id="add-user-modal"
      class="fixed inset-0 hidden items-center justify-center z-50"
    >
      <div class="absolute inset-0 bg-black/40"></div>
      <div
        class="relative bg-white dark:bg-card-dark rounded-lg shadow-lg w-11/12 max-w-lg p-6"
      >
        <h3
          class="text-lg font-semibold text-text-light dark:text-text-dark mb-3"
        >
          Add New User
        </h3>
        <form id="add-user-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Full name</label>
            <input
              id="add-name"
              required
              class="w-full form-input px-3 py-2 rounded-lg border border-primary/10"
              placeholder="Jane Doe"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input
              id="add-email"
              type="email"
              required
              class="w-full form-input px-3 py-2 rounded-lg border border-primary/10"
              placeholder="jane@example.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input
              id="add-password"
              type="password"
              minlength="6"
              class="w-full form-input px-3 py-2 rounded-lg border border-primary/10"
              placeholder="Choose a secure password (min 6 chars)"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select
              id="add-role"
              class="w-full form-select px-3 py-2 rounded-lg border border-primary/10"
            >
              <option value="student">Student</option>
              <option value="admin">Admin</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="add-cancel"
              class="px-4 py-2 rounded-lg bg-gray-200"
            >
              Cancel
            </button>
            <button
              type="submit"
              id="add-submit"
              class="px-4 py-2 rounded-lg bg-primary text-white"
            >
              Create
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast container -->
    <div
      id="toast-container"
      class="fixed bottom-6 right-6 flex flex-col gap-2 z-50"
    ></div>

    <script>
      // Setup logout handler for user management page
      document.addEventListener("DOMContentLoaded", () => {
        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            const confirmed = await showConfirmModal(
              "You will be logged out of your account.",
              "Logout?"
            );
            if (!confirmed) {
              return;
            }
            try {
              await fetch("../php/logout.php", {
                method: "POST",
                credentials: "same-origin",
              });
            } catch (err) {
              console.warn("Logout request failed", err);
            }
            window.location.href = "../login.html";
          });
        }
      });
    </script>
  </body>
</html>
