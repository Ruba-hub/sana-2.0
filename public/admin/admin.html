<!DOCTYPE html>

<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Sana Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#11d452",
              "background-light": "#f6f8f6",
              "background-dark": "#102216",
              "orange-accent": "#ff9f1c",
              "peach-accent": "#ffdab9",
              "text-light": "#102216",
              "text-dark": "#f6f8f6",
              "card-light": "#ffffff",
              "card-dark": "#1a3824",
              "border-light": "#e2e8f0",
              "border-dark": "#2d573d",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };

      // Custom confirmation modal helper
      function showConfirmModal(message, title = "Confirm") {
        return new Promise((resolve) => {
          const overlay = document.createElement("div");
          overlay.className =
            "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4";

          const modal = document.createElement("div");
          modal.className =
            "bg-white dark:bg-card-dark rounded-lg shadow-lg max-w-sm w-full animate-[scale-in_0.2s_ease-out]";
          modal.style.animation = "scale-in 0.2s ease-out";

          modal.innerHTML = `
            <div class="p-6">
              <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-2">${title}</h3>
              <p class="text-text-light dark:text-text-dark mb-6 text-sm leading-relaxed">${message}</p>
              <div class="flex gap-3 justify-end">
                <button 
                  id="confirm-cancel" 
                  class="px-4 py-2 rounded-lg bg-border-light dark:bg-border-dark text-text-light dark:text-text-dark hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-sm"
                >
                  Cancel
                </button>
                <button 
                  id="confirm-ok" 
                  class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors font-medium text-sm"
                >
                  Confirm
                </button>
              </div>
            </div>
          `;

          overlay.appendChild(modal);
          document.body.appendChild(overlay);

          const cleanup = () => {
            overlay.remove();
          };

          document
            .getElementById("confirm-ok")
            .addEventListener("click", () => {
              cleanup();
              resolve(true);
            });

          document
            .getElementById("confirm-cancel")
            .addEventListener("click", () => {
              cleanup();
              resolve(false);
            });

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) {
              cleanup();
              resolve(false);
            }
          });
        });
      }
    </script>
    <style>
      @keyframes scale-in {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
  </head>
  <body
    class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark"
  >
    <script>
      // Global flag to track if session is verified
      window.sessionVerified = false;
      window.isAdmin = false;

      // Check if user is logged in and is an admin
      (async () => {
        try {
          console.log("[Admin] Checking session...");

          const response = await fetch("../php/api.php?action=get_user", {
            method: "GET",
            credentials: "include", // Include cookies for session
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            console.warn("[Admin] API returned status:", response.status);
            window.location.href = "../form.html?error=not_logged_in";
            return;
          }

          const data = await response.json();
          console.log("[Admin] User data:", data);

          if (!data.ok || !data.user) {
            console.warn("[Admin] No user in response or ok is false");
            window.location.href = "../form.html?error=not_logged_in";
            return;
          }

          const userRole = data.user.role || "student";
          console.log("[Admin] User role:", userRole);

          if (userRole !== "admin") {
            console.warn("[Admin] User is not an admin, redirecting");
            window.location.href = "../stdntdashb.html?error=not_admin";
            return;
          }

          // Admin user verified
          window.currentAdminUser = data.user;
          window.sessionVerified = true;
          window.isAdmin = true;
          console.log(
            "[Admin] Session verified for admin:",
            data.user.display_name || data.user.email
          );

          // Update admin name in sidebar
          const adminNameElement = document.querySelector("[data-admin-name]");
          if (adminNameElement && data.user.display_name) {
            adminNameElement.textContent = data.user.display_name;
            console.log(
              "[Admin] Updated admin name to:",
              data.user.display_name
            );
          }

          // Update admin avatar with first letter
          const avatarElement = document.getElementById("admin-avatar-sidebar");
          if (avatarElement && data.user.display_name) {
            const firstLetter = data.user.display_name.charAt(0).toUpperCase();
            avatarElement.textContent = firstLetter;
            console.log("[Admin] Updated admin avatar to:", firstLetter);
          }

          // Load dashboard stats immediately after session verification
          // But wait for DOM to be ready first
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
              setTimeout(() => loadDashboardStats(), 50);
            });
          } else {
            // DOM is already loaded
            setTimeout(() => loadDashboardStats(), 100);
          }
        } catch (error) {
          console.error("[Admin] Session check error:", error);
          window.location.href = "../form.html?error=session_error";
        }
      })();

      // Load dashboard statistics
      async function loadDashboardStats() {
        try {
          console.log("[Admin] Loading dashboard stats...");
          const response = await fetch(
            "../php/api.php?action=get_admin_stats",
            {
              method: "GET",
              credentials: "include",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          console.log("[Admin] API Response status:", response.status);

          if (!response.ok) {
            console.error(
              "[Admin] Failed to fetch stats. Status:",
              response.status
            );
            const errorText = await response.text();
            console.error("[Admin] Error response:", errorText);
            // Retry after 1 second
            setTimeout(() => loadDashboardStats(), 1000);
            return;
          }

          const data = await response.json();
          console.log(
            "[Admin] Dashboard stats response:",
            JSON.stringify(data, null, 2)
          );

          if (!data.ok) {
            console.error("[Admin] API returned ok=false:", data);
            return;
          }

          if (!data.stats) {
            console.error("[Admin] No stats in response:", data);
            return;
          }

          const stats = data.stats;
          const recentUsers = data.recent_users || [];

          console.log("[Admin] Processing stats:", stats);

          // Update stats cards with real data
          updateStatCard("active-users", stats.active_users, "+5.2%");
          updateStatCard("new-signups", stats.new_signups, "+12%");
          updateStatCard("avg-session", stats.avg_session_duration, "-1.5%");
          updateStatCard(
            "wellbeing-score",
            stats.wellbeing_score + "/5",
            "+0.1%"
          );

          // Update engagement
          const engagementValue = document.querySelector("[data-engagement]");
          if (engagementValue) {
            engagementValue.textContent =
              stats.total_engagement.toLocaleString();
            console.log(
              "[Admin] Updated engagement to:",
              stats.total_engagement.toLocaleString()
            );
          } else {
            console.warn("[Admin] Engagement element not found");
          }

          // Update recent users table
          updateRecentUsersTable(recentUsers);

          console.log("[Admin] Dashboard updated with live data");
        } catch (error) {
          console.error("[Admin] Error loading dashboard stats:", error);
          console.error("[Admin] Error stack:", error.stack);
        }
      }

      function updateStatCard(elementId, value, change) {
        console.log(`[Admin] Updating stat card: ${elementId} = ${value}`);
        const card = document.querySelector(`[data-stat="${elementId}"]`);
        if (!card) {
          console.warn(
            `[Admin] Stat card not found: [data-stat="${elementId}"]`
          );
          return;
        }

        const valueEl = card.querySelector(".stat-value");
        const changeEl = card.querySelector(".stat-change");

        if (valueEl) {
          // Format the value: if it's a number, add thousands separator; if it's already a string, use as-is
          let displayValue = value;
          if (typeof value === "number") {
            displayValue = value.toLocaleString();
          }
          valueEl.textContent = displayValue;
          console.log(`[Admin] Updated ${elementId} value to: ${displayValue}`);
        } else {
          console.warn(`[Admin] .stat-value element not found in ${elementId}`);
        }

        if (changeEl) {
          changeEl.textContent = change;
        }
      }

      function updateRecentUsersTable(users) {
        const tbody = document.querySelector("table tbody");
        if (!tbody || users.length === 0) return;

        // Clear existing rows (keep only the header)
        const rows = tbody.querySelectorAll("tr");
        rows.forEach((row) => row.remove());

        // Add new rows from database
        users.forEach((user) => {
          const row = document.createElement("tr");
          row.className =
            "border-b border-border-light dark:border-border-dark";

          row.innerHTML = `
            <td class="p-4 flex items-center gap-3">
              <div
                class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
                style="background-image: url('https://via.placeholder.com/32?text=${encodeURIComponent(
                  user.display_name?.charAt(0) || "U"
                )}');"
              ></div>
              <span>${user.display_name || "N/A"}</span>
            </td>
            <td class="p-4">${user.email || "N/A"}</td>
            <td class="p-4">${new Date(user.created_at).toLocaleDateString(
              "en-US",
              { year: "numeric", month: "short", day: "numeric" }
            )}</td>
            <td class="p-4">
              <span class="inline-flex items-center rounded-full bg-primary/20 px-2.5 py-0.5 text-xs font-medium text-primary">
                Active
              </span>
            </td>
            <td class="p-4 text-right">
              <button class="p-1.5 rounded-md hover:bg-primary/10">
                <span class="material-symbols-outlined text-lg">edit</span>
              </button>
              <button class="p-1.5 rounded-md hover:bg-orange-accent/10 text-orange-accent">
                <span class="material-symbols-outlined text-lg">no_accounts</span>
              </button>
            </td>
          `;

          tbody.appendChild(row);
        });
        // Attach action handlers to newly created rows
        try {
          if (typeof attachUserActionHandlers === "function")
            attachUserActionHandlers();
        } catch (e) {
          console.warn("[Admin] attachUserActionHandlers not available yet", e);
        }
      }

      // Additional refresh on DOM ready (as backup)
      document.addEventListener("DOMContentLoaded", () => {
        console.log("[Admin] DOM loaded, stats should already be loaded");
        setupNotificationPanel();
      });

      // Setup notification panel
      function setupNotificationPanel() {
        const notificationBtn = document.getElementById("notification-btn");
        const notificationPanel = document.getElementById("notification-panel");

        if (!notificationBtn || !notificationPanel) {
          console.warn("[Admin] Notification elements not found");
          return;
        }

        // Toggle panel on button click
        notificationBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          notificationPanel.classList.toggle("hidden");
          if (!notificationPanel.classList.contains("hidden")) {
            loadNotifications();
          }
        });

        // Close panel when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !notificationBtn.contains(e.target) &&
            !notificationPanel.contains(e.target)
          ) {
            notificationPanel.classList.add("hidden");
          }
        });
      }

      // Load notifications
      async function loadNotifications() {
        try {
          console.log("[Admin] Loading notifications...");
          const notificationList = document.getElementById("notification-list");

          // Get recent activities: new users, new messages
          const response = await fetch(
            "../php/api.php?action=get_admin_stats",
            {
              method: "GET",
              credentials: "include",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            notificationList.innerHTML = `
              <div class="p-4 text-center text-orange-accent text-sm">
                Failed to load notifications
              </div>
            `;
            return;
          }

          const data = await response.json();
          if (!data.ok || !data.recent_users) {
            notificationList.innerHTML = `
              <div class="p-4 text-center text-text-light/60 dark:text-text-dark/60 text-sm">
                No recent activity
              </div>
            `;
            return;
          }

          // Build notification list from recent users
          let html = "";
          data.recent_users.slice(0, 5).forEach((user) => {
            const date = new Date(user.created_at);
            const timeAgo = getTimeAgo(date);
            html += `
              <div class="px-4 py-3 border-b border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark cursor-pointer transition">
                <div class="flex items-start gap-3">
                  <div class="w-2 h-2 rounded-full bg-primary mt-1.5 flex-shrink-0"></div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate">${
                      user.display_name || user.email
                    }</p>
                    <p class="text-xs text-text-light/60 dark:text-text-dark/60">Registered ${timeAgo}</p>
                  </div>
                </div>
              </div>
            `;
          });

          if (html === "") {
            html = `
              <div class="p-4 text-center text-text-light/60 dark:text-text-dark/60 text-sm">
                No recent activity
              </div>
            `;
          }

          notificationList.innerHTML = html;
          console.log("[Admin] Notifications loaded");
        } catch (error) {
          console.error("[Admin] Error loading notifications:", error);
          document.getElementById("notification-list").innerHTML = `
            <div class="p-4 text-center text-orange-accent text-sm">
              Error loading notifications
            </div>
          `;
        }
      }

      // Helper function to format time ago
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return "just now";
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;

        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }
    </script>
    <div class="flex h-screen w-full">
      <!-- SideNavBar -->
      <aside
        class="flex w-64 flex-col border-r border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-4"
      >
        <div class="flex items-center gap-3 p-3">
          <div
            id="admin-avatar-sidebar"
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 flex items-center justify-center text-white font-semibold text-sm"
            data-alt="Admin user avatar"
            style="background-color: #4a8f5e"
          >
            A
          </div>
          <div class="flex flex-col">
            <h1 class="text-base font-medium leading-normal" data-admin-name>
              Admin User
            </h1>
            <p
              class="text-sm font-normal leading-normal text-primary/80 dark:text-primary/70"
            >
              Admin Panel
            </p>
          </div>
        </div>
        <nav class="flex flex-grow flex-col gap-2 mt-4">
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 text-text-light dark:text-text-dark"
            href="admin.html"
          >
            <span class="material-symbols-outlined text-xl">dashboard</span>
            <p class="text-sm font-medium leading-normal">Dashboard</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10"
            href="usermgt.html"
          >
            <span class="material-symbols-outlined text-xl">group</span>
            <p class="text-sm font-medium leading-normal">User Management</p>
          </a>

          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10"
            href="adminsettings.html"
          >
            <span class="material-symbols-outlined text-xl">settings</span>
            <p class="text-sm font-medium leading-normal">System Settings</p>
          </a>
        </nav>
        <div class="flex flex-col gap-1">
          <a
            id="admin-logout-btn"
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 cursor-pointer"
            href="#"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <p class="text-sm font-medium leading-normal">Logout</p>
          </a>
        </div>
      </aside>
      <!-- Main Content -->
      <div class="flex flex-1 flex-col overflow-y-auto">
        <!-- TopNavBar -->
        <header
          class="flex h-16 shrink-0 items-center justify-between whitespace-nowrap border-b border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark px-6"
        >
          <div class="flex items-center gap-8">
            <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">
              Dashboard
            </h2>
            <label class="hidden md:flex flex-col min-w-40 !h-10 max-w-64">
              <div
                class="flex w-full flex-1 items-stretch rounded-lg h-full bg-background-light dark:bg-background-dark"
              >
                <div
                  class="text-primary/80 flex items-center justify-center pl-3"
                >
                  <span class="material-symbols-outlined text-xl">search</span>
                </div>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-text-light/60 dark:placeholder:text-text-dark/60 pl-2 text-sm font-normal leading-normal"
                  placeholder="Search..."
                  value=""
                />
              </div>
            </label>
          </div>
          <div class="flex flex-1 items-center justify-end gap-4">
            <div class="relative">
              <button
                id="notification-btn"
                class="flex h-10 w-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-transparent text-text-light dark:text-text-dark hover:bg-primary/10 relative"
              >
                <span class="material-symbols-outlined text-xl"
                  >notifications</span
                >
                <div
                  id="notification-badge"
                  class="absolute top-2 right-2.5 h-2 w-2 rounded-full bg-orange-accent"
                ></div>
              </button>
              <!-- Notification Panel -->
              <div
                id="notification-panel"
                class="absolute right-0 mt-2 w-80 bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-xl shadow-lg hidden z-50"
              >
                <div
                  class="p-4 border-b border-border-light dark:border-border-dark"
                >
                  <h3 class="text-sm font-bold leading-normal">
                    Notifications
                  </h3>
                </div>
                <div id="notification-list" class="max-h-96 overflow-y-auto">
                  <div
                    class="p-4 text-center text-text-light/60 dark:text-text-dark/60 text-sm"
                  >
                    Loading notifications...
                  </div>
                </div>
                <div
                  class="p-3 border-t border-border-light dark:border-border-dark text-center"
                >
                  <button
                    class="text-primary text-sm font-medium hover:underline"
                  >
                    View All
                  </button>
                </div>
              </div>
            </div>
          </div>
        </header>
        <!-- Page Content -->
        <main class="flex-1 p-6 space-y-6">
          <!-- Stats -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div
              class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark"
              data-stat="active-users"
            >
              <p
                class="text-base font-medium leading-normal text-text-light/80 dark:text-text-dark/80"
              >
                Active Users
              </p>
              <p
                class="tracking-light text-3xl font-bold leading-tight stat-value"
              >
                1,420
              </p>
              <p
                class="text-primary text-base font-medium leading-normal stat-change"
              >
                +5.2%
              </p>
            </div>
            <div
              class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark"
              data-stat="new-signups"
            >
              <p
                class="text-base font-medium leading-normal text-text-light/80 dark:text-text-dark/80"
              >
                New Sign-ups
              </p>
              <p
                class="tracking-light text-3xl font-bold leading-tight stat-value"
              >
                89
              </p>
              <p
                class="text-primary text-base font-medium leading-normal stat-change"
              >
                +12%
              </p>
            </div>
            <div
              class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark"
              data-stat="avg-session"
            >
              <p
                class="text-base font-medium leading-normal text-text-light/80 dark:text-text-dark/80"
              >
                Avg. Session Duration
              </p>
              <p
                class="tracking-light text-3xl font-bold leading-tight stat-value"
              >
                12m 45s
              </p>
              <p
                class="text-red-500 text-base font-medium leading-normal stat-change"
              >
                -1.5%
              </p>
            </div>
            <div
              class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark"
              data-stat="wellbeing-score"
            >
              <p
                class="text-base font-medium leading-normal text-text-light/80 dark:text-text-dark/80"
              >
                Well-being Score
              </p>
              <p
                class="tracking-light text-3xl font-bold leading-tight stat-value"
              >
                4.2/5
              </p>
              <p
                class="text-primary text-base font-medium leading-normal stat-change"
              >
                +0.1%
              </p>
            </div>
          </div>
          <!-- Charts -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div
              class="flex min-w-72 flex-1 flex-col gap-2 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6"
            >
              <p class="text-base font-medium leading-normal">
                User Engagement
              </p>
              <p
                class="tracking-light text-[32px] font-bold leading-tight truncate"
                data-engagement
              >
                12,845
              </p>
              <div class="flex gap-1">
                <p
                  class="text-text-light/60 dark:text-text-dark/60 text-base font-normal leading-normal"
                >
                  Last 30 Days
                </p>
                <p class="text-primary text-base font-medium leading-normal">
                  +15.3%
                </p>
              </div>
              <div class="flex min-h-[220px] flex-1 flex-col gap-8 py-4">
                <svg
                  fill="none"
                  height="100%"
                  preserveaspectratio="none"
                  viewbox="-3 0 478 150"
                  width="100%"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z"
                    fill="url(#paint0_linear_chart)"
                  ></path>
                  <path
                    d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25"
                    stroke="#11d452"
                    stroke-linecap="round"
                    stroke-width="3"
                  ></path>
                  <defs>
                    <lineargradient
                      gradientunits="userSpaceOnUse"
                      id="paint0_linear_chart"
                      x1="236"
                      x2="236"
                      y1="1"
                      y2="149"
                    >
                      <stop stop-color="#11d452" stop-opacity="0.2"></stop>
                      <stop
                        offset="1"
                        stop-color="#11d452"
                        stop-opacity="0"
                      ></stop>
                    </lineargradient>
                  </defs>
                </svg>
              </div>
            </div>
            <div
              class="flex min-w-72 flex-1 flex-col gap-2 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6"
            >
              <p class="text-base font-medium leading-normal">Feature Usage</p>
              <p
                class="tracking-light text-[32px] font-bold leading-tight truncate"
              >
                Top Feature: Chat
              </p>
              <div class="flex gap-1">
                <p
                  class="text-text-light/60 dark:text-text-dark/60 text-base font-normal leading-normal"
                >
                  This Month
                </p>
                <p class="text-primary text-base font-medium leading-normal">
                  +8.1%
                </p>
              </div>
              <div
                class="grid min-h-[220px] grid-flow-col gap-6 grid-rows-[1fr_auto] items-end justify-items-center px-3 pt-4"
              >
                <div
                  class="bg-primary/30 w-full rounded-t-lg"
                  style="height: 100%"
                ></div>
                <p
                  class="text-text-light/80 dark:text-text-dark/80 text-[13px] font-bold leading-normal tracking-[0.015em]"
                >
                  Chats
                </p>
                <div
                  class="bg-primary/30 w-full rounded-t-lg"
                  style="height: 60%"
                ></div>
                <p
                  class="text-text-light/80 dark:text-text-dark/80 text-[13px] font-bold leading-normal tracking-[0.015em]"
                >
                  Journal
                </p>
                <div
                  class="bg-primary/30 w-full rounded-t-lg"
                  style="height: 45%"
                ></div>
                <p
                  class="text-text-light/80 dark:text-text-dark/80 text-[13px] font-bold leading-normal tracking-[0.015em]"
                >
                  Mood Logging
                </p>
              </div>
            </div>
          </div>
          <!-- Recent Users Table -->
          <div
            class="flex flex-col gap-4 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6"
          >
            <div class="flex items-center justify-between">
              <h3
                class="text-[22px] font-bold leading-tight tracking-[-0.015em]"
              >
                Recent Users
              </h3>
              <button
                class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-primary text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-4 hover:bg-primary/90"
              >
                View All
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead>
                  <tr
                    class="border-b border-border-light dark:border-border-dark text-text-light/60 dark:text-text-dark/60"
                  >
                    <th class="p-4 font-medium">Name</th>
                    <th class="p-4 font-medium">Email</th>
                    <th class="p-4 font-medium">Registered</th>
                    <th class="p-4 font-medium">Status</th>
                    <th class="p-4 font-medium text-right">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    class="border-b border-border-light dark:border-border-dark"
                  >
                    <td class="p-4 flex items-center gap-3">
                      <div
                        class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
                        data-alt="User avatar for Olivia Rhye"
                        style="
                          background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBJx8zUSTTZAJsG1D1dMSyQiGMOQlPuR06_0-eP_RsWPoCwMUVBX9PgPX57uPDpCiH-PneaGuqXbljvCwCPnSgd3y-cW_s5iJ73MZjTO8qywtL7UxBbC-satA07hFR7hCEG-idIiwVJYj18CsQY0TYidnXtu59eg_0LlHyjUYaIrDc31bkyipmd3nrn0LyM0Nb3qaSUVFCCFuQ1JWXQ37TGa6Lv9K6nAfoKEwu8dBjcYyS9sx_--qrkyLxTKaO8k1vxMq4I3OlwxQ');
                        "
                      ></div>
                      <span>Olivia Rhye</span>
                    </td>
                    <td class="p-4">Stanford University</td>
                    <td class="p-4">Jan 20, 2024</td>
                    <td class="p-4">
                      <span
                        class="inline-flex items-center rounded-full bg-primary/20 px-2.5 py-0.5 text-xs font-medium text-primary"
                        >Active</span
                      >
                    </td>
                    <td class="p-4 text-right">
                      <button class="p-1.5 rounded-md hover:bg-primary/10">
                        <span class="material-symbols-outlined text-lg"
                          >edit</span
                        >
                      </button>
                      <button
                        class="p-1.5 rounded-md hover:bg-orange-accent/10 text-orange-accent"
                      >
                        <span class="material-symbols-outlined text-lg"
                          >no_accounts</span
                        >
                      </button>
                    </td>
                  </tr>
                  <tr
                    class="border-b border-border-light dark:border-border-dark"
                  >
                    <td class="p-4 flex items-center gap-3">
                      <div
                        class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
                        data-alt="User avatar for Phoenix Baker"
                        style="
                          background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDMqXX6OmKgrcWY8hBjZg4JvY6spKBBltQM7Q1W8528NiGtOWfPhfwXbGjUBDOAd3wRo_EK4uP4yCPnHW1dRn16PNYsGfT-on5Ti3yd91nk_Ru_sDJnu7hbcZH0jBdLLEw_gUm_rJR7N83BuJD5MlAPEPpu1U8YWjslBJsZhFernF9IOSsTfa1Xf0ykU-g5VkzxMyXgXELLDF1pRkNm6N1xk4G78swZ7PW2GxiuWEcVNOS9gUd73-HfiKo5FpMcejNVNs5-x2VQ8Q');
                        "
                      ></div>
                      <span>Phoenix Baker</span>
                    </td>
                    <td class="p-4">Harvard University</td>
                    <td class="p-4">Jan 18, 2024</td>
                    <td class="p-4">
                      <span
                        class="inline-flex items-center rounded-full bg-primary/20 px-2.5 py-0.5 text-xs font-medium text-primary"
                        >Active</span
                      >
                    </td>
                    <td class="p-4 text-right">
                      <button class="p-1.5 rounded-md hover:bg-primary/10">
                        <span class="material-symbols-outlined text-lg"
                          >edit</span
                        >
                      </button>
                      <button
                        class="p-1.5 rounded-md hover:bg-orange-accent/10 text-orange-accent"
                      >
                        <span class="material-symbols-outlined text-lg"
                          >no_accounts</span
                        >
                      </button>
                    </td>
                  </tr>
                  <tr
                    class="border-b border-border-light dark:border-border-dark"
                  >
                    <td class="p-4 flex items-center gap-3">
                      <div
                        class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
                        data-alt="User avatar for Lana Steiner"
                        style="
                          background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBNpn9BMYDvROEXNJSQ9SQnt_WvxlzaH6DWHkQod2Paw85xjlCN7C2ejnq8Yu-En3iuhRr4Cvcm6A854vAfe8Sf4OHtZ0IUVWGZYSKlFwMdEamBEV01T1VP94j3w3wEQGxRyYZb3oxDeDftDTl1JE9aCQ8QQvpAxP8QApzpSiv8MlgJF-rfjMjj-4_Ct0U1FHlLYsnED08d2OvdusWxiEVhE1os245qEQ1y_kqBlIUhV22UpVOkB2T0rKPLB-WSDj9w1M2-AiPyDg');
                        "
                      ></div>
                      <span>Lana Steiner</span>
                    </td>
                    <td class="p-4">MIT</td>
                    <td class="p-4">Jan 15, 2024</td>
                    <td class="p-4">
                      <span
                        class="inline-flex items-center rounded-full bg-orange-accent/20 px-2.5 py-0.5 text-xs font-medium text-orange-accent"
                        >Suspended</span
                      >
                    </td>
                    <td class="p-4 text-right">
                      <button class="p-1.5 rounded-md hover:bg-primary/10">
                        <span class="material-symbols-outlined text-lg"
                          >edit</span
                        >
                      </button>
                      <button
                        class="p-1.5 rounded-md hover:bg-orange-accent/10 text-orange-accent"
                      >
                        <span class="material-symbols-outlined text-lg"
                          >no_accounts</span
                        >
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td class="p-4 flex items-center gap-3">
                      <div
                        class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
                        data-alt="User avatar for Demi Wilkinson"
                        style="
                          background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDxKTvc8wla8E884OWdcwY983PP5INRfcKpNKnB0PN9g3y5ktvGVDuwG5F9D8G2BQfW3F5r0rUWmmS0ol3GJgSvV4lxqyOa29hNiC7GFQGxvC2r3_Tfts-deTxsx7VPLp8aZXpDaWVXbmQ8ksyE3d82ASEhpIoMZ1MDEBk2D6XEBrMoQq2B7-ctSJ4_o4oBMqHAXsFsKkcE8d97g5hsg9J-5Ab8xKUdjTqsfOlbmbd15aCKNapVhen2xbIC7Ifoircs20wsDzfZoQ');
                        "
                      ></div>
                      <span>Demi Wilkinson</span>
                    </td>
                    <td class="p-4">UC Berkeley</td>
                    <td class="p-4">Jan 12, 2024</td>
                    <td class="p-4">
                      <span
                        class="inline-flex items-center rounded-full bg-primary/20 px-2.5 py-0.5 text-xs font-medium text-primary"
                        >Active</span
                      >
                    </td>
                    <td class="p-4 text-right">
                      <button class="p-1.5 rounded-md hover:bg-primary/10">
                        <span class="material-symbols-outlined text-lg"
                          >edit</span
                        >
                      </button>
                      <button
                        class="p-1.5 rounded-md hover:bg-orange-accent/10 text-orange-accent"
                      >
                        <span class="material-symbols-outlined text-lg"
                          >no_accounts</span
                        >
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>
  </body>
</html>

<script>
  // Create modal and toast elements dynamically and expose helper functions
  function createModalElements() {
    if (document.getElementById("confirm-modal")) return;

    // Confirm modal
    const modal = document.createElement("div");
    modal.id = "confirm-modal";
    modal.className = "fixed inset-0 hidden items-center justify-center z-50";
    modal.innerHTML = `
     <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
     <div class="relative bg-white dark:bg-card-dark rounded-lg shadow-lg w-11/12 max-w-md p-6">
       <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-3" id="confirm-modal-title">Confirm</h3>
       <p class="text-sm text-text-light/80 dark:text-text-dark/80 mb-6" id="confirm-modal-message">Are you sure?</p>
       <div class="flex justify-end gap-3">
         <button id="confirm-modal-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-text-light">Cancel</button>
         <button id="confirm-modal-ok" class="px-4 py-2 rounded-lg bg-primary text-white">OK</button>
       </div>
     </div>
   `;
    document.body.appendChild(modal);

    // Toast container
    const toasts = document.createElement("div");
    toasts.id = "toast-container";
    toasts.className = "fixed bottom-6 right-6 flex flex-col gap-2 z-50";
    document.body.appendChild(toasts);

    // Hook buttons
    const okBtn = modal.querySelector("#confirm-modal-ok");
    const cancelBtn = modal.querySelector("#confirm-modal-cancel");
    okBtn.addEventListener("click", () => {
      modal.dispatchEvent(new CustomEvent("confirm:ok"));
    });
    cancelBtn.addEventListener("click", () => {
      modal.dispatchEvent(new CustomEvent("confirm:cancel"));
    });
  }

  function showConfirmModal(
    message,
    title = "Confirm",
    okText = "OK",
    cancelText = "Cancel"
  ) {
    return new Promise((resolve) => {
      createModalElements();
      const modal = document.getElementById("confirm-modal");
      modal.querySelector("#confirm-modal-title").textContent = title;
      modal.querySelector("#confirm-modal-message").textContent = message;
      modal.querySelector("#confirm-modal-ok").textContent = okText;
      modal.querySelector("#confirm-modal-cancel").textContent = cancelText;
      modal.classList.remove("hidden");
      modal.classList.add("flex");

      function cleanup() {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modal.removeEventListener("confirm:ok", onOk);
        modal.removeEventListener("confirm:cancel", onCancel);
      }

      function onOk() {
        cleanup();
        resolve(true);
      }
      function onCancel() {
        cleanup();
        resolve(false);
      }

      modal.addEventListener("confirm:ok", onOk);
      modal.addEventListener("confirm:cancel", onCancel);
    });
  }

  function showToast(message, type = "success", timeout = 3000) {
    createModalElements();
    const container = document.getElementById("toast-container");
    const t = document.createElement("div");
    t.className = `rounded-lg px-4 py-2 shadow-md text-sm text-white ${
      type === "error" ? "bg-red-500" : "bg-green-500"
    }`;
    t.textContent = message;
    container.appendChild(t);
    setTimeout(() => {
      t.classList.add("opacity-0");
      setTimeout(() => t.remove(), 300);
    }, timeout);
  }

  // Attach handlers for edit / suspend buttons in Recent Users table
  function attachUserActionHandlers() {
    // find all rows in the recent users table
    const table = document.querySelector("table.w-full.text-left.text-sm");
    if (!table) return;
    const tbody = table.querySelector("tbody");
    if (!tbody) return;

    tbody.querySelectorAll("tr").forEach((row) => {
      const actionButtons = row.querySelectorAll("td:last-child button");
      if (!actionButtons) return;
      actionButtons.forEach((btn) => {
        const icon = btn.querySelector(".material-symbols-outlined");
        if (!icon) return;
        const name = icon.textContent.trim();
        if (name === "edit") {
          btn.addEventListener("click", (e) => handleEditUser(row));
        }
        if (name === "no_accounts") {
          btn.addEventListener("click", (e) => handleToggleSuspend(row));
        }
      });
    });
  }

  function getRowEmail(row) {
    // second cell is email in this table layout
    const cells = row.querySelectorAll("td");
    if (cells.length < 2) return null;
    return cells[1].textContent.trim();
  }

  async function handleEditUser(row) {
    const currentEmail = getRowEmail(row);
    if (!currentEmail) return showToast("Cannot determine user email", "error");

    const currentName =
      row.querySelector("td:first-child span")?.textContent?.trim() || "";
    const currentRoleText =
      row.querySelectorAll("td")[3]?.textContent?.trim() || "";

    const newName = prompt("Edit display name:", currentName);
    if (newName === null) return; // cancelled
    const newEmail = prompt("Edit email:", currentEmail);
    if (newEmail === null) return;
    const newRole = prompt(
      "Role (admin/student/suspended):",
      currentRoleText.toLowerCase().includes("suspended")
        ? "suspended"
        : "student"
    );
    if (newRole === null) return;

    try {
      const res = await fetch("../php/api.php?action=update_user", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: currentEmail,
          display_name: newName,
          new_email: newEmail,
          role: newRole,
        }),
      });
      const data = await res.json();
      if (!data.ok)
        return showToast(
          "Update failed: " + (data.error || "unknown"),
          "error"
        );

      // Update UI row
      row.querySelector("td:first-child span").textContent =
        data.user.display_name || newName;
      row.querySelectorAll("td")[1].textContent = data.user.email || newEmail;
      const statusCell = row.querySelectorAll("td")[3];
      if (data.user.role === "suspended") {
        statusCell.innerHTML =
          '<span class="inline-flex items-center rounded-full bg-orange-accent/20 px-2.5 py-0.5 text-xs font-medium text-orange-accent">Suspended</span>';
      } else {
        statusCell.innerHTML =
          '<span class="inline-flex items-center rounded-full bg-primary/20 px-2.5 py-0.5 text-xs font-medium text-primary">Active</span>';
      }
      showToast("User updated", "success");
    } catch (err) {
      console.error("Update user error", err);
      showToast("Update failed", "error");
    }
  }

  async function handleToggleSuspend(row) {
    const currentEmail = getRowEmail(row);
    if (!currentEmail) return showToast("Cannot determine user email", "error");
    const statusCell = row.querySelectorAll("td")[3];
    const statusText = statusCell.textContent || "";
    const isSuspended = statusText.toLowerCase().includes("suspended");
    const confirmMsg = isSuspended
      ? "Activate this user?"
      : "Suspend this user?";

    const proceed = await showConfirmModal(
      confirmMsg,
      isSuspended ? "Activate user" : "Suspend user",
      isSuspended ? "Activate" : "Suspend",
      "Cancel"
    );
    if (!proceed) return;

    const newRole = isSuspended ? "student" : "suspended";
    try {
      const res = await fetch("../php/api.php?action=set_user_role", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: currentEmail, role: newRole }),
      });
      const data = await res.json();
      if (!data.ok)
        return showToast(
          "Action failed: " + (data.error || "unknown"),
          "error"
        );

      if (data.user.role === "suspended") {
        statusCell.innerHTML =
          '<span class="inline-flex items-center rounded-full bg-orange-accent/20 px-2.5 py-0.5 text-xs font-medium text-orange-accent">Suspended</span>';
      } else {
        statusCell.innerHTML =
          '<span class="inline-flex items-center rounded-full bg-primary/20 px-2.5 py-0.5 text-xs font-medium text-primary">Active</span>';
      }
      showToast("Status updated", "success");
    } catch (err) {
      console.error("Toggle suspend error", err);
      showToast("Action failed", "error");
    }
  }

  // Attach after DOM load - also re-run after dashboard load if needed
  document.addEventListener("DOMContentLoaded", () => {
    createModalElements();
    attachUserActionHandlers();

    // Setup logout handler
    const logoutBtn = document.getElementById("admin-logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const confirmed = await showConfirmModal(
          "You will be logged out of your account.",
          "Logout?"
        );
        if (!confirmed) {
          return;
        }
        try {
          await fetch("../php/logout.php", {
            method: "POST",
            credentials: "same-origin",
          });
        } catch (err) {
          console.warn("Logout request failed", err);
        }
        window.location.href = "../login.html";
      });
    }
  });
</script>
